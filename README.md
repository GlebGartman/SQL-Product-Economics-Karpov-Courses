<h3 align="center">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</h3>
<p align="center">
–ü—Ä–æ–µ–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ —Ä–∞–º–∫–∞—Ö –∫—É—Ä—Å–∞ <strong>Karpov.Courses</strong> –∏ –ø–æ—Å–≤—è—â—ë–Ω –∞–Ω–∞–ª–∏–∑—É –∫–ª—é—á–µ–≤—ã—Ö –±–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫ —Ä–æ–∑–Ω–∏—á–Ω–æ–π —Å–µ—Ç–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SQL –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π –≤ Redash. –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á—ë—Ç–æ–≤ –ø–æ –¥–∞–Ω–Ω—ã–º –∏–∑ –±–∞–∑—ã <strong>PostgreSQL</strong> —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –æ—Ü–µ–Ω–∫—É —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å–∞ –∏ —ç–∫–æ–Ω–æ–º–∏–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞.
–í —Ä–∞–º–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª–∏—Å—å –∏ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏—Å—å —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏: –≤—ã—Ä—É—á–∫–∞, –∑–∞—Ç—Ä–∞—Ç—ã, –ø—Ä–∏–±—ã–ª—å, ARPU, ARPPU, AOV –∏ –¥—Ä—É–≥–∏–µ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏. –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–∏–º–µ–Ω—è–ª–∏—Å—å SQL-–∑–∞–ø—Ä–æ—Å—ã —Ä–∞–∑–ª–∏—á–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏, –≤–∫–ª—é—á–∞—è LEFT/RIGHT/INNER JOIN, –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∞–≥—Ä–µ–≥–∞—Ç—ã –∏ CTE.
</p>


<details>
<summary><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</strong></summary>

<summary><strong>–ó–∞–¥–∞–Ω–∏–µ 1: –î–∏–Ω–∞–º–∏–∫–∞ –≤—ã—Ä—É—á–∫–∏</strong></summary>

üìå –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –≤ —Ç–∞–±–ª–∏—Ü–µ `orders` —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:

- `revenue` ‚Äî –≤—ã—Ä—É—á–∫–∞, –ø–æ–ª—É—á–µ–Ω–Ω–∞—è –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å  
- `total_revenue` ‚Äî —Å—É–º–º–∞—Ä–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ —Å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ–º –Ω–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å  
- `revenue_change` ‚Äî –ø—Ä–∏—Ä–æ—Å—Ç –≤—ã—Ä—É—á–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è (–≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö)  
- `date` ‚Äî –¥–∞—Ç–∞

üìä –ü—Ä–∏—Ä–æ—Å—Ç (`revenue_change`) —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –∏ –æ–∫—Ä—É–≥–ª—ë–Ω –¥–æ –¥–≤—É—Ö –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π.  
üìÖ –†–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ –¥–∞—Ç–µ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é.

### –ö–æ–¥

```sql
WITH plat as (
   SELECT order_id
   FROM user_actions
   group by order_id
   HAVING count(order_id) = 1
   order by order_id
   )
   

 
 SELECT date, revenue, total_revenue, ROUND((revenue - pred) * 100 / pred::NUMERIC, 2) as revenue_change FROM
  (SELECT date, revenue, sum(revenue) over(order by date) as total_revenue,lag(revenue, 1) over(order by date) as pred FROM
   (SELECT creation_time::DATE as date, sum(price) as revenue FROM  
     (SELECT order_id, creation_time, UNNEST(product_ids) as product_id FROM orders
      WHERE order_id in (SELECT * FROM plat)
      order by order_id) as tovars 
     JOIN products as p on p.product_id = tovars.product_id
    group by date  
    order by date) as stoimost) as vyruchka

```
### –î–∏–Ω–∞–º–∏–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –≤—ã—Ä—É—á–∫–∏

![–ì—Ä–∞—Ñ–∏–∫: –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –≤—ã—Ä—É—á–∫–∞](https://drive.google.com/uc?export=view&id=1wnMQZ8oBvM9LLPocvOJPkUo2j-er-hI8)

### –î–∏–Ω–∞–º–∏–∫–∞ –æ–±—â–µ–π –≤—ã—Ä—É—á–∫–∏ (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ)

![–ì—Ä–∞—Ñ–∏–∫: –æ–±—â–∞—è –≤—ã—Ä—É—á–∫–∞](https://drive.google.com/uc?export=view&id=1FgKToK7wIoRHEanw1q0oFB_yeVns8eSH)

---

<summary><strong>–ó–∞–¥–∞–Ω–∏–µ 2: ARPU, ARPPU –∏ AOV</strong></summary>

üìå –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤—ã—Ä—É—á–∫–∏:

- `arpu` ‚Äî —Å—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Average Revenue Per User)  
- `arppu` ‚Äî —Å—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–ª–∞—Ç—è—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Average Revenue Per Paying User)  
- `aov` ‚Äî —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫, –∏–ª–∏ –≤—ã—Ä—É—á–∫–∞ —Å –∑–∞–∫–∞–∑–∞ (Average Order Value)  
- `date` ‚Äî –¥–∞—Ç–∞

üí° –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–∫—Ä—É–≥–ª–µ–Ω—ã –¥–æ –¥–≤—É—Ö –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π.  
üìÖ –¢–∞–±–ª–∏—Ü–∞ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ –¥–∞—Ç–µ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é.


### –ö–æ–¥

```sql
WITH plat as (
   SELECT order_id
   FROM user_actions
   group by order_id
   HAVING count(order_id) = 1
   order by order_id
   )
   

SELECT date,
  ROUND(revenue::NUMERIC / kolvo_user::NUMERIC, 2) as arpu,
  ROUND(revenue / plat_user::NUMERIC, 2) as arppu,
  ROUND(revenue / plat_zakaz::NUMERIC, 2) as aov
  FROM  
   (SELECT date,
    sum(revenue) FILTER (WHERE order_id in (SELECT * FROM plat)) as revenue,
    count(DISTINCT user_id) FILTER (WHERE order_id in (SELECT * FROM plat)) as plat_user,
    count(DISTINCT user_id) as kolvo_user,
    count(DISTINCT order_id) FILTER (WHERE order_id in (SELECT * FROM plat)) as plat_zakaz
    FROM
     (SELECT time::DATE as date, user_id, ua.order_id, action, revenue FROM
      (SELECT  order_id, sum(price) as revenue FROM  
       (SELECT order_id, creation_time, UNNEST(product_ids) as product_id FROM orders) as tovars 
        LEFT JOIN products as p on p.product_id = tovars.product_id
        group by order_id) as product_orders
       LEFT JOIN user_actions as ua on ua.order_id = product_orders.order_id
       order by date) as zakazy
   group by date) as metrics

```

### –î–∏–Ω–∞–º–∏–∫–∞ ARPU, ARPPU –∏ AOV

![–ì—Ä–∞—Ñ–∏–∫: ARPU, ARPPU –∏ AOV](https://drive.google.com/uc?export=view&id=1GBh7PlWGE_gLX7AmiZPuRZ7y0s5GwYI7)

---

<summary><strong>–ó–∞–¥–∞–Ω–∏–µ 3: –ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ ‚Äî Running ARPU, ARPPU, AOV</strong></summary>

üìå –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤—ã—Ä—É—á–∫–∏:

- `running_arpu` ‚Äî –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
- `running_arppu` ‚Äî –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–ª–∞—Ç—è—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
- `running_aov` ‚Äî –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ –Ω–∞ –æ–¥–∏–Ω –∑–∞–∫–∞–∑ (—Å—Ä–µ–¥–Ω–∏–π —á–µ–∫)  
- `date` ‚Äî –¥–∞—Ç–∞

üí° –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–∫—Ä—É–≥–ª–µ–Ω—ã –¥–æ –¥–≤—É—Ö –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π.  
üìÖ –†–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –¥–∞—Ç—ã.


### –ö–æ–¥

```sql
WITH plat as (
   SELECT order_id
   FROM user_actions
   group by order_id
   HAVING count(order_id) = 1
   order by order_id
   ), 
   
  unique_day_users_pay as (SELECT date, COUNT(user_id) AS new_paying_users 
    FROM ( 
        SELECT user_id, MIN(time::date) AS date 
        FROM user_actions 
        WHERE order_id NOT IN (SELECT order_id FROM user_actions WHERE action = 'cancel_order') 
        GROUP BY user_id 
    ) as data GROUP BY date),
   
 unique_day_users as 
 (
SELECT time_user, count(time_user) FILTER(WHERE porydok = 1) as new_users, count(time_user) FILTER(WHERE numer = 1) as new_users_plat FROM 
 (SELECT user_id, order_id, time::date AS time_user, ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY time) AS porydok,
   CASE 
     WHEN order_id IN (SELECT order_id FROM plat) THEN 
       ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY time)
   END AS numer
 FROM user_actions
    order by user_id) as porydok_users
 group by time_user
 order by time_user)
   
--SELECT * FROM plat 
--SELECT * FROM unique_day_users
 
  SELECT date,
  ROUND(sum_nakop::NUMERIC / kolvo_user_nakop::NUMERIC, 2) as running_arpu,
  ROUND(sum_nakop / plat_user_nakop::NUMERIC, 2) as running_arppu,
  ROUND(sum_nakop / plat_zakaz_nakop::NUMERIC, 2) as running_aov
  FROM  
   (
   SELECT date,
    sum(revenue) over(order by date) as sum_nakop,
    sum(plat_user) over(order by date) as plat_user_nakop,
    sum(kolvo_user) over(order by date) as kolvo_user_nakop,
    sum(plat_zakaz) over(order by date) as plat_zakaz_nakop
    FROM
    (SELECT zakazy.date as date,
      sum(revenue) FILTER (WHERE order_id in (SELECT * FROM plat)) as revenue,
      new_users as kolvo_user,
      new_paying_users  as plat_user,
      count(DISTINCT order_id) FILTER (WHERE order_id in (SELECT * FROM plat)) as plat_zakaz
      FROM
       (SELECT time::DATE as date, user_id, ua.order_id, action, revenue FROM
        (SELECT  order_id, sum(price) as revenue FROM  
         (SELECT order_id, creation_time, UNNEST(product_ids) as product_id FROM orders) as tovars 
          LEFT JOIN products as p on p.product_id = tovars.product_id
          group by order_id) as product_orders
         LEFT JOIN user_actions as ua on ua.order_id = product_orders.order_id
         order by date) as zakazy
     JOIN  unique_day_users on unique_day_users.time_user = zakazy.date
     JOIN unique_day_users_pay on unique_day_users_pay.date = zakazy.date
     group by zakazy.date, new_users,new_paying_users) as nakoplen) as metrics

```

### –î–∏–Ω–∞–º–∏–∫–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π ARPU, ARPPU –∏ AOV

![–ì—Ä–∞—Ñ–∏–∫: Running ARPU, ARPPU, AOV](https://drive.google.com/uc?export=view&id=1ztIPPDoIO_9OkPGshcYPdZXzQnMV-tDz)

---


</details>
