<h3 align="center">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</h3>
<p align="center">
–ü—Ä–æ–µ–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ —Ä–∞–º–∫–∞—Ö –∫—É—Ä—Å–∞ <strong>Karpov.Courses</strong> –∏ –ø–æ—Å–≤—è—â—ë–Ω –∞–Ω–∞–ª–∏–∑—É –∫–ª—é—á–µ–≤—ã—Ö –±–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫ —Ä–æ–∑–Ω–∏—á–Ω–æ–π —Å–µ—Ç–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SQL –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π –≤ Redash. –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á—ë—Ç–æ–≤ –ø–æ –¥–∞–Ω–Ω—ã–º –∏–∑ –±–∞–∑—ã <strong>PostgreSQL</strong> —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –æ—Ü–µ–Ω–∫—É —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å–∞ –∏ —ç–∫–æ–Ω–æ–º–∏–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∞.
–í —Ä–∞–º–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª–∏—Å—å –∏ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏—Å—å —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏: –≤—ã—Ä—É—á–∫–∞, –∑–∞—Ç—Ä–∞—Ç—ã, –ø—Ä–∏–±—ã–ª—å, ARPU, ARPPU, AOV –∏ –¥—Ä—É–≥–∏–µ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏. –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–∏–º–µ–Ω—è–ª–∏—Å—å SQL-–∑–∞–ø—Ä–æ—Å—ã —Ä–∞–∑–ª–∏—á–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏, –≤–∫–ª—é—á–∞—è LEFT/RIGHT/INNER JOIN, –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∞–≥—Ä–µ–≥–∞—Ç—ã –∏ CTE.
</p>


<details>
<summary><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</strong></summary>

<summary><strong>–ó–∞–¥–∞–Ω–∏–µ 1: –î–∏–Ω–∞–º–∏–∫–∞ –≤—ã—Ä—É—á–∫–∏</strong></summary>

üìå –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –≤ —Ç–∞–±–ª–∏—Ü–µ `orders` —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:

- `revenue` ‚Äî –≤—ã—Ä—É—á–∫–∞, –ø–æ–ª—É—á–µ–Ω–Ω–∞—è –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å  
- `total_revenue` ‚Äî —Å—É–º–º–∞—Ä–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ —Å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ–º –Ω–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å  
- `revenue_change` ‚Äî –ø—Ä–∏—Ä–æ—Å—Ç –≤—ã—Ä—É—á–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è (–≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö)  
- `date` ‚Äî –¥–∞—Ç–∞

üìä –ü—Ä–∏—Ä–æ—Å—Ç (`revenue_change`) —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –∏ –æ–∫—Ä—É–≥–ª—ë–Ω –¥–æ –¥–≤—É—Ö –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π.  
üìÖ –†–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ –¥–∞—Ç–µ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é.

### –ö–æ–¥

```sql
WITH plat as (
   SELECT order_id
   FROM user_actions
   group by order_id
   HAVING count(order_id) = 1
   order by order_id
   )
   

 
 SELECT date, revenue, total_revenue, ROUND((revenue - pred) * 100 / pred::NUMERIC, 2) as revenue_change FROM
  (SELECT date, revenue, sum(revenue) over(order by date) as total_revenue,lag(revenue, 1) over(order by date) as pred FROM
   (SELECT creation_time::DATE as date, sum(price) as revenue FROM  
     (SELECT order_id, creation_time, UNNEST(product_ids) as product_id FROM orders
      WHERE order_id in (SELECT * FROM plat)
      order by order_id) as tovars 
     JOIN products as p on p.product_id = tovars.product_id
    group by date  
    order by date) as stoimost) as vyruchka

```
### –î–∏–Ω–∞–º–∏–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –≤—ã—Ä—É—á–∫–∏

![–ì—Ä–∞—Ñ–∏–∫: –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –≤—ã—Ä—É—á–∫–∞](https://drive.google.com/uc?export=view&id=1wnMQZ8oBvM9LLPocvOJPkUo2j-er-hI8)

### –î–∏–Ω–∞–º–∏–∫–∞ –æ–±—â–µ–π –≤—ã—Ä—É—á–∫–∏ (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ)

![–ì—Ä–∞—Ñ–∏–∫: –æ–±—â–∞—è –≤—ã—Ä—É—á–∫–∞](https://drive.google.com/uc?export=view&id=1FgKToK7wIoRHEanw1q0oFB_yeVns8eSH)

---

<summary><strong>–ó–∞–¥–∞–Ω–∏–µ 2: ARPU, ARPPU –∏ AOV</strong></summary>

üìå –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤—ã—Ä—É—á–∫–∏:

- `arpu` ‚Äî —Å—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Average Revenue Per User)  
- `arppu` ‚Äî —Å—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–ª–∞—Ç—è—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Average Revenue Per Paying User)  
- `aov` ‚Äî —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫, –∏–ª–∏ –≤—ã—Ä—É—á–∫–∞ —Å –∑–∞–∫–∞–∑–∞ (Average Order Value)  
- `date` ‚Äî –¥–∞—Ç–∞

üí° –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–∫—Ä—É–≥–ª–µ–Ω—ã –¥–æ –¥–≤—É—Ö –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π.  
üìÖ –¢–∞–±–ª–∏—Ü–∞ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ –¥–∞—Ç–µ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é.


### –ö–æ–¥

```sql
WITH plat as (
   SELECT order_id
   FROM user_actions
   group by order_id
   HAVING count(order_id) = 1
   order by order_id
   )
   

SELECT date,
  ROUND(revenue::NUMERIC / kolvo_user::NUMERIC, 2) as arpu,
  ROUND(revenue / plat_user::NUMERIC, 2) as arppu,
  ROUND(revenue / plat_zakaz::NUMERIC, 2) as aov
  FROM  
   (SELECT date,
    sum(revenue) FILTER (WHERE order_id in (SELECT * FROM plat)) as revenue,
    count(DISTINCT user_id) FILTER (WHERE order_id in (SELECT * FROM plat)) as plat_user,
    count(DISTINCT user_id) as kolvo_user,
    count(DISTINCT order_id) FILTER (WHERE order_id in (SELECT * FROM plat)) as plat_zakaz
    FROM
     (SELECT time::DATE as date, user_id, ua.order_id, action, revenue FROM
      (SELECT  order_id, sum(price) as revenue FROM  
       (SELECT order_id, creation_time, UNNEST(product_ids) as product_id FROM orders) as tovars 
        LEFT JOIN products as p on p.product_id = tovars.product_id
        group by order_id) as product_orders
       LEFT JOIN user_actions as ua on ua.order_id = product_orders.order_id
       order by date) as zakazy
   group by date) as metrics

```

### –î–∏–Ω–∞–º–∏–∫–∞ ARPU, ARPPU –∏ AOV

![–ì—Ä–∞—Ñ–∏–∫: ARPU, ARPPU –∏ AOV](https://drive.google.com/uc?export=view&id=1GBh7PlWGE_gLX7AmiZPuRZ7y0s5GwYI7)

---

<summary><strong>–ó–∞–¥–∞–Ω–∏–µ 3: –ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ ‚Äî Running ARPU, ARPPU, AOV</strong></summary>

üìå –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤—ã—Ä—É—á–∫–∏:

- `running_arpu` ‚Äî –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
- `running_arppu` ‚Äî –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–ª–∞—Ç—è—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
- `running_aov` ‚Äî –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ –Ω–∞ –æ–¥–∏–Ω –∑–∞–∫–∞–∑ (—Å—Ä–µ–¥–Ω–∏–π —á–µ–∫)  
- `date` ‚Äî –¥–∞—Ç–∞

üí° –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–∫—Ä—É–≥–ª–µ–Ω—ã –¥–æ –¥–≤—É—Ö –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π.  
üìÖ –†–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –¥–∞—Ç—ã.


### –ö–æ–¥

```sql
WITH plat as (
   SELECT order_id
   FROM user_actions
   group by order_id
   HAVING count(order_id) = 1
   order by order_id
   ), 
   
  unique_day_users_pay as (SELECT date, COUNT(user_id) AS new_paying_users 
    FROM ( 
        SELECT user_id, MIN(time::date) AS date 
        FROM user_actions 
        WHERE order_id NOT IN (SELECT order_id FROM user_actions WHERE action = 'cancel_order') 
        GROUP BY user_id 
    ) as data GROUP BY date),
   
 unique_day_users as 
 (
SELECT time_user, count(time_user) FILTER(WHERE porydok = 1) as new_users, count(time_user) FILTER(WHERE numer = 1) as new_users_plat FROM 
 (SELECT user_id, order_id, time::date AS time_user, ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY time) AS porydok,
   CASE 
     WHEN order_id IN (SELECT order_id FROM plat) THEN 
       ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY time)
   END AS numer
 FROM user_actions
    order by user_id) as porydok_users
 group by time_user
 order by time_user)
   
--SELECT * FROM plat 
--SELECT * FROM unique_day_users
 
  SELECT date,
  ROUND(sum_nakop::NUMERIC / kolvo_user_nakop::NUMERIC, 2) as running_arpu,
  ROUND(sum_nakop / plat_user_nakop::NUMERIC, 2) as running_arppu,
  ROUND(sum_nakop / plat_zakaz_nakop::NUMERIC, 2) as running_aov
  FROM  
   (
   SELECT date,
    sum(revenue) over(order by date) as sum_nakop,
    sum(plat_user) over(order by date) as plat_user_nakop,
    sum(kolvo_user) over(order by date) as kolvo_user_nakop,
    sum(plat_zakaz) over(order by date) as plat_zakaz_nakop
    FROM
    (SELECT zakazy.date as date,
      sum(revenue) FILTER (WHERE order_id in (SELECT * FROM plat)) as revenue,
      new_users as kolvo_user,
      new_paying_users  as plat_user,
      count(DISTINCT order_id) FILTER (WHERE order_id in (SELECT * FROM plat)) as plat_zakaz
      FROM
       (SELECT time::DATE as date, user_id, ua.order_id, action, revenue FROM
        (SELECT  order_id, sum(price) as revenue FROM  
         (SELECT order_id, creation_time, UNNEST(product_ids) as product_id FROM orders) as tovars 
          LEFT JOIN products as p on p.product_id = tovars.product_id
          group by order_id) as product_orders
         LEFT JOIN user_actions as ua on ua.order_id = product_orders.order_id
         order by date) as zakazy
     JOIN  unique_day_users on unique_day_users.time_user = zakazy.date
     JOIN unique_day_users_pay on unique_day_users_pay.date = zakazy.date
     group by zakazy.date, new_users,new_paying_users) as nakoplen) as metrics

```

### –î–∏–Ω–∞–º–∏–∫–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π ARPU, ARPPU –∏ AOV

![–ì—Ä–∞—Ñ–∏–∫: Running ARPU, ARPPU, AOV](https://drive.google.com/uc?export=view&id=1ztIPPDoIO_9OkPGshcYPdZXzQnMV-tDz)

---

<summary><strong>–ó–∞–¥–∞–Ω–∏–µ 4: –ú–µ—Ç—Ä–∏–∫–∏ ARPU / ARPPU / AOV –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</strong></summary>

üìå –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –Ω–µ–¥–µ–ª–∏ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ —Å **26 –∞–≤–≥—É—Å—Ç–∞ –ø–æ 8 —Å–µ–Ω—Ç—è–±—Ä—è 2022 –≥–æ–¥–∞** —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:

- `arpu` ‚Äî –≤—ã—Ä—É—á–∫–∞ –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
- `arppu` ‚Äî –≤—ã—Ä—É—á–∫–∞ –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–ª–∞—Ç—è—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
- `aov` ‚Äî –≤—ã—Ä—É—á–∫–∞ –Ω–∞ –æ–¥–∏–Ω –∑–∞–∫–∞–∑ (—Å—Ä–µ–¥–Ω–∏–π —á–µ–∫)  
- `weekday` ‚Äî –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –¥–Ω—è –Ω–µ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Monday)  
- `weekday_number` ‚Äî –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –¥–Ω—è –Ω–µ–¥–µ–ª–∏ (1 ‚Äî Monday, 7 ‚Äî Sunday)

üìÜ –í —Ä–∞—Å—á—ë—Ç –≤–∫–ª—é—á–µ–Ω–æ **—Ä–æ–≤–Ω–æ –ø–æ –¥–≤–∞ –¥–Ω—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –Ω–µ–¥–µ–ª–∏**.  
üìä –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–∫—Ä—É–≥–ª–µ–Ω—ã –¥–æ –¥–≤—É—Ö –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π.  
üìÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ `weekday_number`.


### –ö–æ–¥

```sql
   WITH plat as (
   SELECT order_id
   FROM user_actions
   group by order_id
   HAVING count(order_id) = 1
   order by order_id
   )
   
  SELECT
  weekday,
  weekday_number, 
  ROUND(revenue::NUMERIC / kolvo_user::NUMERIC, 2) as arpu,
  ROUND(revenue / plat_user::NUMERIC, 2) as arppu,
  ROUND(revenue / plat_zakaz::NUMERIC, 2) as aov
  FROM  
   (SELECT weekday, weekday_number, 
    sum(revenue) FILTER (WHERE order_id in (SELECT * FROM plat)) as revenue,
    count(DISTINCT user_id) FILTER (WHERE order_id in (SELECT * FROM plat)) as plat_user,
    count(DISTINCT user_id) as kolvo_user,
    count(DISTINCT order_id) FILTER (WHERE order_id in (SELECT * FROM plat)) as plat_zakaz
      FROM
      (SELECT to_char(date, 'Day') as weekday, DATE_PART('ISODOW', date) as weekday_number, date, user_id, order_id, action, revenue FROM
       (SELECT time::DATE as date, user_id, ua.order_id, action, revenue FROM
        (SELECT  order_id, sum(price) as revenue FROM  
         (SELECT order_id, creation_time, UNNEST(product_ids) as product_id FROM orders) as tovars 
          LEFT JOIN products as p on p.product_id = tovars.product_id
          group by order_id) as product_orders
         LEFT JOIN user_actions as ua on ua.order_id = product_orders.order_id
         order by date) as zakazy
       WHERE date >= '2022-08-26' and date < '2022-09-09') as dni
      group by weekday_number, weekday) as metrics
     order by weekday_number, weekday

```


### –î–∏–Ω–∞–º–∏–∫–∞ ARPU, ARPPU –∏ AOV –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏

![–ì—Ä–∞—Ñ–∏–∫: ARPU, ARPPU –∏ AOV –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏](https://drive.google.com/uc?export=view&id=1LOUmfJ0Ok6BYfrWdnK3uV963YYFhJIdH)

---

<summary><strong>–ó–∞–¥–∞–Ω–∏–µ 5: –î–æ–ª—è –≤—ã—Ä—É—á–∫–∏ –æ—Ç –Ω–æ–≤—ã—Ö –∏ —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</strong></summary>

üìå –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:

- `revenue` ‚Äî –æ–±—â–∞—è –≤—ã—Ä—É—á–∫–∞, –ø–æ–ª—É—á–µ–Ω–Ω–∞—è –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å  
- `new_users_revenue` ‚Äî –≤—ã—Ä—É—á–∫–∞ –æ—Ç –∑–∞–∫–∞–∑–æ–≤ **–Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**  
- `new_users_revenue_share` ‚Äî –¥–æ–ª—è –≤—ã—Ä—É—á–∫–∏ –æ—Ç –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (%)  
- `old_users_revenue_share` ‚Äî –¥–æ–ª—è –≤—ã—Ä—É—á–∫–∏ –æ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (%)  
- `date` ‚Äî –¥–∞—Ç–∞

üìä –í—Å–µ –¥–æ–ª–∏ –≤—ã—Ä–∞–∂–µ–Ω—ã –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –∏ –æ–∫—Ä—É–≥–ª–µ–Ω—ã –¥–æ –¥–≤—É—Ö –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π.  
üìÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –¥–∞—Ç—ã.


### –ö–æ–¥

```sql

WITH plat as (
   SELECT order_id
   FROM user_actions
   group by order_id
   HAVING count(order_id) = 1
   order by order_id
   ),
   
unique_day_users_pay as (
SELECT user_id, MIN(time::date) AS date 
        FROM user_actions 
        GROUP BY user_id 
    )
  
   
  SELECT date, 
  revenue,
  new_users_revenue,
  ROUND(new_users_revenue * 100 / revenue::NUMERIC, 2) as new_users_revenue_share,
  ROUND((revenue - new_users_revenue) * 100 / revenue::NUMERIC, 2) as old_users_revenue_share
  FROM
   (SELECT date, sum(revenue) as revenue, sum(revenue) FILTER(WHERE pay_user_id IS NOT NULL) as new_users_revenue FROM 
     (SELECT time::DATE as date, ua.user_id as user_id, uap.user_id as pay_user_id, ua.order_id, revenue FROM 
      (SELECT order_id, sum(price) as revenue FROM
       (SELECT order_id, UNNEST(product_ids) as product_id FROM orders
        WHERE order_id in (SELECT * FROM plat) 
        order by order_id) as tovars
       JOIN products as p on p.product_id = tovars.product_id
       group by order_id) as zakazy
     JOIN user_actions as ua on ua.order_id = zakazy.order_id
     LEFT JOIN unique_day_users_pay as uap on uap.user_id = ua.user_id and uap.date = ua.time::DATE
    order by user_id, date) as stoimost
   group by date) as revenues
  order by date
 
```

### –î–∏–Ω–∞–º–∏–∫–∞ –¥–æ–ª–µ–π –≤—ã—Ä—É—á–∫–∏ –æ—Ç –Ω–æ–≤—ã—Ö –∏ —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

![–ì—Ä–∞—Ñ–∏–∫: –¥–æ–ª—è –≤—ã—Ä—É—á–∫–∏ –æ—Ç –Ω–æ–≤—ã—Ö –∏ —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π](https://drive.google.com/uc?export=view&id=1vaeeKo5-r8VhzXq4dtVVC83t0QVuLSAm)

---

<summary><strong>–ó–∞–¥–∞–Ω–∏–µ 6: –í—ã—Ä—É—á–∫–∞ –ø–æ —Ç–æ–≤–∞—Ä–∞–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–î–†–£–ì–û–ï"</strong></summary>

üìå –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∑–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥:

- `product_name` ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞  
- `revenue` ‚Äî —Å—É–º–º–∞—Ä–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ –æ—Ç —Ç–æ–≤–∞—Ä–∞  
- `share_in_revenue` ‚Äî –¥–æ–ª—è –≤—ã—Ä—É—á–∫–∏ –æ—Ç —Ç–æ–≤–∞—Ä–∞ –≤ –æ–±—â–µ–π –≤—ã—Ä—É—á–∫–µ (%)

üî¢ –î–æ–ª—è (`share_in_revenue`) –æ–∫—Ä—É–≥–ª–µ–Ω–∞ –¥–æ –¥–≤—É—Ö –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π –∏ –≤—ã—Ä–∞–∂–µ–Ω–∞ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö.  
üîª –í—Å–µ —Ç–æ–≤–∞—Ä—ã —Å –¥–æ–ª–µ–π **–º–µ–Ω–µ–µ 0.5%** –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é **–î–†–£–ì–û–ï**, —Å —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏—Ö –æ–∫—Ä—É–≥–ª—ë–Ω–Ω—ã—Ö –¥–æ–ª–µ–π.  
üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ —É–±—ã–≤–∞–Ω–∏—é –≤—ã—Ä—É—á–∫–∏.


### –ö–æ–¥

```sql

WITH plat as (
SELECT order_id
FROM user_actions
group by order_id 
HAVING count(order_id) = 1
order by order_id 
)


  SELECT product_name, sum(revenue) as revenue, sum(procent) as share_in_revenue FROM 
   (SELECT 
    CASE    
    WHEN procent < 0.5 THEN '–î–†–£–ì–û–ï'  
    ELSE name
    END as product_name,
    revenue,
    procent 
    FROM
   (SELECT name, revenue, ROUND(revenue * 100 / summa::NUMERIC, 2) as procent FROM
    (SELECT name, revenue, sum(revenue) over() as summa FROM 
      (SELECT name, sum(price) as revenue FROM
       (SELECT order_id, UNNEST(product_ids) as product_id FROM orders
        WHERE order_id in (SELECT * FROM plat)
        order by order_id) as tovars
      JOIN  products as p on p.product_id = tovars.product_id
      group by name) as prices) as vyruchka) as procents) as category
    group by product_name
    order by revenue desc

```


### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—ã—Ä—É—á–∫–∏ –ø–æ —Ç–æ–≤–∞—Ä–∞–º

![–ì—Ä–∞—Ñ–∏–∫: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—ã—Ä—É—á–∫–∏ –ø–æ —Ç–æ–≤–∞—Ä–∞–º](https://drive.google.com/uc?export=view&id=1ukvUlSa2VnscRBG4WaNsa15gsD4KaF_0)

---

<summary><strong>–ó–∞–¥–∞–Ω–∏–µ 7: –í—ã—Ä—É—á–∫–∞, –∑–∞—Ç—Ä–∞—Ç—ã –∏ –≤–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å</strong></summary>

üìå –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:

- `revenue` ‚Äî –≤—ã—Ä—É—á–∫–∞, –ø–æ–ª—É—á–µ–Ω–Ω–∞—è –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å  
- `costs` ‚Äî –∑–∞—Ç—Ä–∞—Ç—ã –∫—É—Ä—å–µ—Ä–æ–≤ –∑–∞ –¥–µ–Ω—å  
- `tax` ‚Äî —Å—É–º–º–∞ –ù–î–° —Å –ø—Ä–æ–¥–∞–∂–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ –¥–µ–Ω—å  
- `gross_profit` ‚Äî –≤–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å –∑–∞ –¥–µ–Ω—å (–≤—ã—Ä—É—á–∫–∞ ‚àí –∑–∞—Ç—Ä–∞—Ç—ã ‚àí –ù–î–°)  
- `total_revenue` ‚Äî –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –≤—ã—Ä—É—á–∫–∞  
- `total_costs` ‚Äî –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã  
- `total_tax` ‚Äî –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –ù–î–°  
- `total_gross_profit` ‚Äî –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –≤–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å  
- `gross_profit_ratio` ‚Äî –¥–æ–ª—è –≤–∞–ª–æ–≤–æ–π –ø—Ä–∏–±—ã–ª–∏ –≤ –≤—ã—Ä—É—á–∫–µ –∑–∞ –¥–µ–Ω—å (%)  
- `total_gross_profit_ratio` ‚Äî –¥–æ–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π –≤–∞–ª–æ–≤–æ–π –ø—Ä–∏–±—ã–ª–∏ –≤ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π –≤—ã—Ä—É—á–∫–µ (%)

üìä –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–µ–π –≤—ã—Ä–∞–∂–µ–Ω—ã –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –∏ –æ–∫—Ä—É–≥–ª–µ–Ω—ã –¥–æ –¥–≤—É—Ö –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π.  
üìÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –¥–∞—Ç—ã.



### –ö–æ–¥

```sql
WITH plat as (
SELECT order_id
FROM user_actions
group by order_id 
HAVING count(order_id) = 1
order by order_id 
), 

nalog as (SELECT order_id, sum(price) as price, sum(nds) as nds 
 FROM
  (SELECT order_id, name, price,
  CASE 
  WHEN name in ('—Å–∞—Ö–∞—Ä', '—Å—É—Ö–∞—Ä–∏–∫–∏', '—Å—É—à–∫–∏', '—Å–µ–º–µ—á–∫–∏', 
'–º–∞—Å–ª–æ –ª—å–Ω—è–Ω–æ–µ', '–≤–∏–Ω–æ–≥—Ä–∞–¥', '–º–∞—Å–ª–æ –æ–ª–∏–≤–∫–æ–≤–æ–µ', 
'–∞—Ä–±—É–∑', '–±–∞—Ç–æ–Ω', '–π–æ–≥—É—Ä—Ç', '—Å–ª–∏–≤–∫–∏', '–≥—Ä–µ—á–∫–∞', 
'–æ–≤—Å—è–Ω–∫–∞', '–º–∞–∫–∞—Ä–æ–Ω—ã', '–±–∞—Ä–∞–Ω–∏–Ω–∞', '–∞–ø–µ–ª—å—Å–∏–Ω—ã', 
'–±—É–±–ª–∏–∫–∏', '—Ö–ª–µ–±', '–≥–æ—Ä–æ—Ö', '—Å–º–µ—Ç–∞–Ω–∞', '—Ä—ã–±–∞ –∫–æ–ø—á–µ–Ω–∞—è', 
'–º—É–∫–∞', '—à–ø—Ä–æ—Ç—ã', '—Å–æ—Å–∏—Å–∫–∏', '—Å–≤–∏–Ω–∏–Ω–∞', '—Ä–∏—Å', 
'–º–∞—Å–ª–æ –∫—É–Ω–∂—É—Ç–Ω–æ–µ', '—Å–≥—É—â–µ–Ω–∫–∞', '–∞–Ω–∞–Ω–∞—Å', '–≥–æ–≤—è–¥–∏–Ω–∞', 
'—Å–æ–ª—å', '—Ä—ã–±–∞ –≤—è–ª–µ–Ω–∞—è', '–º–∞—Å–ª–æ –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ', '—è–±–ª–æ–∫–∏', 
'–≥—Ä—É—à–∏', '–ª–µ–ø–µ—à–∫–∞', '–º–æ–ª–æ–∫–æ', '–∫—É—Ä–∏—Ü–∞', '–ª–∞–≤–∞—à', '–≤–∞—Ñ–ª–∏', '–º–∞–Ω–¥–∞—Ä–∏–Ω—ã')

THEN ROUND(price  / 11::NUMERIC, 2)
ELSE ROUND(price  / 6::NUMERIC, 2)
END as NDS
FROM
   (SELECT order_id, name, price FROM 
        (SELECT order_id, UNNEST(product_ids) as product_id FROM orders
         WHERE order_id in (SELECT * FROM plat)
         order by order_id) as tovars
       JOIN products as p on p.product_id = tovars.product_id
       order by order_id) as names) as spisok
 group by order_id),
 
--–í–ê–ñ–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê!!!
nakop as  (SELECT  date, revenue, tax, total_revenue, total_tax, zatrata_na_sborka + zatrata_v_day as zatraty_users
  FROM
  (SELECT date, price as revenue, nds as tax,
   sum(price) over(order by date) as total_revenue, sum(nds) over(order by date) total_tax, 
   kolvo,
   CASE   
   WHEN DATE_PART('month', date) = 8 THEN kolvo * 140
   ELSE kolvo * 115
   END as zatrata_na_sborka,
   CASE   
   WHEN DATE_PART('month', date) = 8 THEN 120000
   ELSE 150000
   END as zatrata_v_day
   FROM   
  (SELECT date, sum(price) as price, sum(nds) as nds, count(order_id) as kolvo FROM
     (SELECT user_id, ua.order_id as order_id,  time::DATE as date, price, nds FROM nalog as n    
      JOIN user_actions as ua on ua.order_id = n.order_id
      order by user_id) as summa
    group by date
    order by date) as zarabotok) as money
    ),
    
couriers as (SELECT courier_id, order_id, time::DATE as date FROM courier_actions
   WHERE order_id in (SELECT * FROM plat) and action = 'deliver_order'
   order by courier_id),
   

 zatrata_na_couriera as (SELECT date, kolvo * 150 as zatrata_na_kyry   
    FROM
    (SELECT date, count(order_id) as kolvo FROM couriers
     group by date
     order by date) as chislo),
     
   
 top_five as (SELECT date, 
  CASE   
  WHEN DATE_PART('month', date) = 8 THEN kolvo_top * 400
   ELSE kolvo_top * 500
   END as zatrata_na_top_5
   FROM
   (SELECT date, count(kolvo) as kolvo_top
    FROM 
    (SELECT courier_id, date, count(order_id) as kolvo FROM couriers
     group by courier_id, date
     HAVING count(order_id) >= 5  
     order by date) as top
    group by date
    order by date) as top_5),
    
  --–í–ê–ñ–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê!!!   
 zatrata_couriers as (SELECT date, zatrata_na_kyry + zatrata_na_top_5 as zatrata_day_couriers FROM
   (SELECT znc.date, zatrata_na_kyry, COALESCE(zatrata_na_top_5, 0) as zatrata_na_top_5 FROM zatrata_na_couriera AS znc
     LEFT JOIN  top_five as tf on tf.date = znc.date) as zatraty_obchie_couries)
   
  
  SELECT date,
   revenue, costs, tax,
   gross_profit,
   total_revenue, total_costs, total_tax, 
   total_gross_profit,
   gross_profit_ratio, 
   ROUND(total_gross_profit * 100 / total_revenue::NUMERIC, 2) as total_gross_profit_ratio
   FROM
   (SELECT date,
   revenue, costs, tax,
   gross_profit,
   total_revenue, total_costs, total_tax, 
   sum(gross_profit) over(order by date) as total_gross_profit,
   ROUND(gross_profit * 100 / revenue::NUMERIC, 2) as gross_profit_ratio
   FROM
    (SELECT  date, revenue, tax, costs,
     revenue - tax - costs as gross_profit,
     total_revenue, total_tax, sum(costs) over(order by date) as total_costs
     FROM 
      (SELECT n.date as date, revenue, tax, total_revenue, total_tax, (zatraty_users + zatrata_day_couriers)::NUMERIC as costs FROM nakop as n   
       JOIN zatrata_couriers as zc on zc.date = n.date) as podvodka) as podchet) as metrics

```

### –î–∏–Ω–∞–º–∏–∫–∞ –≤–∞–ª–æ–≤–æ–π –ø—Ä–∏–±—ã–ª–∏ –∏ –µ—ë –¥–æ–ª–∏ –≤ –≤—ã—Ä—É—á–∫–µ  
![gross profit](https://drive.google.com/uc?export=view&id=1ukvUlSa2VnscRBG4WaNsa15gsD4KaF_0)

---

### –°—É–º–º–∞—Ä–Ω–∞—è –≤–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å –∏ –µ—ë –¥–æ–ª—è –≤ —Å—É–º–º–∞—Ä–Ω–æ–π –≤—ã—Ä—É—á–∫–µ  
![total gross profit](https://drive.google.com/uc?export=view&id=1CVtQGU1bV5H8xnGoC5VXOPo2jeqIcWiX)



</details>

<details> 

<summary><strong>–í—ã–≤–æ–¥—ã</strong></summary>

üìå –ù–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∏ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ –±—ã–ª –ø–æ—Å—Ç—Ä–æ–µ–Ω –∏—Ç–æ–≥–æ–≤—ã–π –¥–∞—à–±–æ—Ä–¥.

üîó [–û—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥ –≤ Redash](https://redash.public.karpov.courses/public/dashboards/SpodlHrsXdn5vTDNirtCWJcINDuch1fuqHRx0mFD?org_slug=default)

</details>
